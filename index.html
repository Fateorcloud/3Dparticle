<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Hand (Local)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: none; }
        #input_video { position: absolute; top: -9999px; left: -9999px; transform: scaleX(-1); }
        
        #loading {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: #00ff88; font-size: 16px; text-align: center; width: 100%; pointer-events: none;
        }
        
        #ui-bar {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 15px; z-index: 100;
        }
        .btn {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: #fff; padding: 10px 20px; border-radius: 20px; backdrop-filter: blur(5px);
        }
        .btn.active { background: #00ff88; color: #000; border: none; font-weight: bold; }
    </style>

    <script src="assets/three.min.js"></script>
    <script src="assets/camera_utils.js"></script>
    <script src="assets/control_utils.js"></script>
    <script src="assets/drawing_utils.js"></script>
    <script src="assets/hands.js"></script>
</head>
<body>

    <div id="loading">ğŸš€ æ­£åœ¨åŠ è½½ä»“åº“å†…æ¨¡å‹...<br>æ— éœ€è”ç½‘ä¸‹è½½ï¼Œæé€Ÿå¯åŠ¨</div>
    <video id="input_video" playsinline webkit-playsinline></video>

    <div id="ui-bar">
        <button class="btn active" onclick="setShape('heart', this)">â¤</button>
        <button class="btn" onclick="setShape('saturn', this)">ğŸª</button>
    </div>

<script>
    const PARTICLE_COUNT = 15000;
    let scene, camera, renderer, particles, material;
    let basePositions = new Float32Array(PARTICLE_COUNT * 3);
    let handScale = 1.0, targetScale = 1.0;

    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 25;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(PARTICLE_COUNT * 3);
        for(let i=0; i<PARTICLE_COUNT*3; i++) pos[i] = (Math.random()-0.5)*60;
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        material = new THREE.PointsMaterial({ color: 0x00ff88, size: 0.2, transparent: true, opacity: 0.8 });
        particles = new THREE.Points(geo, material);
        scene.add(particles);
        generateShape('heart');
        animate();
    }

    function generateShape(type) {
        for(let i=0; i<PARTICLE_COUNT; i++) {
            const t = Math.random()*Math.PI*2, p = Math.acos(2*Math.random()-1);
            let x=0,y=0,z=0;
            if(type==='heart') {
                x=16*Math.pow(Math.sin(t),3); y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); z=(Math.random()-0.5)*4;
                let s=Math.cbrt(Math.random())*0.6; x*=s;y*=s;z*=s;
            } else { 
                 if(Math.random()>0.5) { let r=7*Math.cbrt(Math.random()); x=r*Math.sin(p)*Math.cos(t); y=r*Math.sin(p)*Math.sin(t); z=r*Math.cos(p); }
                 else { let r=Math.sqrt(Math.random()*150+50); x=r*Math.cos(t); y=r*Math.sin(t)*0.4; z=r*Math.sin(t)*0.5; y+=x*0.2; }
            }
            basePositions[i*3]=x; basePositions[i*3+1]=y; basePositions[i*3+2]=z;
        }
    }

    // 2. æ ¸å¿ƒï¼šå¼ºåˆ¶ä» assets æ–‡ä»¶å¤¹åŠ è½½æ¨¡å‹
    const hands = new Hands({
        locateFile: (file) => {
            // è¿™è¡Œä»£ç æ„å‘³ç€ï¼šä¸ç®¡è¦åŠ è½½ä»€ä¹ˆwasm/tfliteæ–‡ä»¶
            // éƒ½å»å½“å‰çš„ assets/ æ–‡ä»¶å¤¹é‡Œæ‰¾ï¼
            return `assets/${file}`;
        }
    });

    hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5 });
    hands.onResults(results => {
        document.getElementById('loading').style.display = 'none';
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const d = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
            targetScale = 0.2 + d * 5; 
            material.color.setHex(0xff0055);
        } else {
            material.color.setHex(0x00ff88);
        }
    });

    const videoEl = document.getElementById('input_video');
    const cameraUtils = new Camera(videoEl, {
        onFrame: async () => { await hands.send({image: videoEl}); },
        width: 640, height: 480, facingMode: "user"
    });

    initThree();
    setTimeout(() => { cameraUtils.start(); }, 500);

    function animate() {
        requestAnimationFrame(animate);
        handScale += (targetScale - handScale) * 0.1;
        const pos = particles.geometry.attributes.position.array;
        for(let i=0; i<PARTICLE_COUNT*3; i++) {
            pos[i] += (basePositions[i]*handScale - pos[i])*0.1;
        }
        particles.geometry.attributes.position.needsUpdate = true;
        scene.rotation.y += 0.003;
        renderer.render(scene, camera);
    }
    
    window.setShape = function(type, btn) {
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        generateShape(type);
    }
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
