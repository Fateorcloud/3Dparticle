<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3Dç²’å­æ‰‹åŠ¿ (æ‰‹æœºæé€Ÿç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: none; }
        /* è§†é¢‘éœ€è¦é•œåƒç¿»è½¬ï¼Œå¦åˆ™æ“ä½œæ˜¯åçš„ */
        #input_video { position: absolute; top: -9999px; left: -9999px; transform: scaleX(-1); }
        
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ff88; font-size: 16px; text-align: center; width: 100%;
            text-shadow: 0 0 10px rgba(0,255,136,0.5); pointer-events: none;
            transition: opacity 0.5s;
        }
        
        /* ç®€å•çš„æ‰‹æœºç«¯ UI */
        #ui-bar {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 10px; z-index: 100;
        }
        .btn {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 14px;
            backdrop-filter: blur(5px);
        }
        .btn.active { background: #00d2ff; color: #000; font-weight: bold; border: none; }
    </style>

    <script src="https://registry.npmmirror.com/three/0.146.0/files/build/three.min.js"></script>
    <script src="https://registry.npmmirror.com/@mediapipe/camera_utils/0.3.1675466862/files/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://registry.npmmirror.com/@mediapipe/control_utils/0.6.1675466026/files/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://registry.npmmirror.com/@mediapipe/drawing_utils/0.3.1675466124/files/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://registry.npmmirror.com/@mediapipe/hands/0.4.1675469240/files/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loading">ğŸš€ æ­£åœ¨ä»é˜¿é‡Œäº‘åŠ è½½ AI æ¨¡å‹...<br><span style="font-size:12px;color:#aaa">é¦–æ¬¡åŠ è½½çº¦éœ€ 3-5 ç§’</span></div>
    <video id="input_video" playsinline webkit-playsinline></video>

    <div id="ui-bar">
        <button class="btn active" onclick="setShape('heart', this)">â¤ çˆ±å¿ƒ</button>
        <button class="btn" onclick="setShape('flower', this)">ğŸŒ¸ èŠ±æœµ</button>
        <button class="btn" onclick="setShape('saturn', this)">ğŸª åœŸæ˜Ÿ</button>
    </div>

<script>
    // === é’ˆå¯¹æ‰‹æœºæ€§èƒ½çš„é…ç½® ===
    const PARTICLE_COUNT = 15000; // é™ä½ç²’å­æ•°ä»¥ä¿è¯æ‰‹æœºæµç•…
    const PARTICLE_SIZE = 0.15;   // ç²’å­å¤§ä¸€ç‚¹ï¼Œæ›´å¥½çœ‹
    
    let scene, camera, renderer, particles, material;
    let basePositions = new Float32Array(PARTICLE_COUNT * 3);
    let handScale = 1.0, targetScale = 1.0;

    // === 1. åˆå§‹åŒ– 3D åœºæ™¯ ===
    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 25;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // é™åˆ¶åƒç´ æ¯”ï¼Œçœç”µ
        document.body.appendChild(renderer.domElement);

        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(PARTICLE_COUNT * 3);
        // åˆå§‹æ•£å¼€
        for(let i=0; i<PARTICLE_COUNT*3; i++) positions[i] = (Math.random()-0.5) * 60;
        
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        material = new THREE.PointsMaterial({
            color: 0x00d2ff, size: PARTICLE_SIZE, 
            transparent: true, opacity: 0.8, 
            blending: THREE.AdditiveBlending
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);

        generateShape('heart');
        animate();
    }

    // === 2. å½¢çŠ¶ç®—æ³• ===
    function generateShape(type) {
        for(let i=0; i<PARTICLE_COUNT; i++) {
            const idx = i*3;
            const t = Math.random() * Math.PI * 2;
            const p = Math.acos(2 * Math.random() - 1);
            let x=0, y=0, z=0;

            if(type==='heart') {
                x = 16 * Math.pow(Math.sin(t), 3);
                y = 13 * Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
                z = (Math.random()-0.5)*4;
                let s = Math.cbrt(Math.random()) * 0.6; x*=s; y*=s; z*=s;
            } else if(type==='flower') {
                let r = (10 * Math.cos(5*t) + 5) * Math.random();
                x=r*Math.cos(t); y=r*Math.sin(t); z=(Math.random()-0.5)*5;
            } else { // saturn
                if(Math.random()>0.5) { 
                    let r=7*Math.cbrt(Math.random()); 
                    x=r*Math.sin(p)*Math.cos(t); y=r*Math.sin(p)*Math.sin(t); z=r*Math.cos(p);
                } else {
                    let r = Math.sqrt(Math.random()*(200-50)+50);
                    x=r*Math.cos(t); y=r*Math.sin(t)*0.4; z=r*Math.sin(t)*0.5; y+=x*0.2;
                }
            }
            basePositions[idx]=x; basePositions[idx+1]=y; basePositions[idx+2]=z;
        }
    }

    // === 3. æ ¸å¿ƒï¼šä½¿ç”¨æ·˜å®æºåŠ è½½ AI æ¨¡å‹ (æ‰‹æœºç«¯å…³é”®) ===
    const hands = new Hands({
        locateFile: (file) => {
            // å¼ºåˆ¶æ‰€æœ‰ .wasm å’Œ .tflite æ–‡ä»¶éƒ½èµ°æ·˜å®é•œåƒ
            // è¿™æ˜¯ç›®å‰å›½å†…å…¬ç½‘æœ€å¿«çš„è·¯å¾„
            return `https://registry.npmmirror.com/@mediapipe/hands/0.4.1675469240/files/${file}`;
        }
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0, // æ‰‹æœºç«¯è®¾ä¸º 0 (Liteæ¨¡å‹)ï¼Œé€Ÿåº¦æœ€å¿«ï¼Œå‘çƒ­æœ€å°‘ï¼
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(results => {
        document.getElementById('loading').style.opacity = 0; // éšè—åŠ è½½æç¤º
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            // ç®€å•çš„è·ç¦»è®¡ç®—
            const d = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
            targetScale = 0.2 + d * 5; 
            material.color.setHex(0x00ff88); // è¯†åˆ«åˆ°å˜ç»¿
        } else {
            material.color.setHex(0x00d2ff); // æœªè¯†åˆ«å˜è“
        }
    });

    // === 4. æ‘„åƒå¤´å¯åŠ¨ (å¼ºåˆ¶å‰ç½®) ===
    const videoEl = document.getElementById('input_video');
    const cameraUtils = new Camera(videoEl, {
        onFrame: async () => { await hands.send({image: videoEl}); },
        width: 640, height: 480, // é™ä½åˆ†è¾¨ç‡ä»¥æé«˜æ‰‹æœºå¸§ç‡
        facingMode: "user" // å¼ºåˆ¶å‰ç½®æ‘„åƒå¤´
    });

    // å»¶æ—¶å¯åŠ¨ï¼Œé˜²æ­¢å¡é¡¿
    initThree();
    setTimeout(() => {
        cameraUtils.start().catch(e => {
            alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼\nè¯·ç¡®ä¿ï¼š\n1. ç½‘ç«™æ˜¯ HTTPS åè®®\n2. å…è®¸äº†æ‘„åƒå¤´æƒé™");
        });
    }, 1000);

    // === åŠ¨ç”»å¾ªç¯ ===
    function animate() {
        requestAnimationFrame(animate);
        handScale += (targetScale - handScale) * 0.1;
        
        const pos = particles.geometry.attributes.position.array;
        for(let i=0; i<PARTICLE_COUNT; i++) {
            const idx = i*3;
            pos[idx] += (basePositions[idx]*handScale - pos[idx]) * 0.1;
            pos[idx+1] += (basePositions[idx+1]*handScale - pos[idx+1]) * 0.1;
            pos[idx+2] += (basePositions[idx+2]*handScale - pos[idx+2]) * 0.1;
        }
        particles.geometry.attributes.position.needsUpdate = true;
        scene.rotation.y += 0.002; // ç¼“æ…¢è‡ªè½¬
        renderer.render(scene, camera);
    }

    // æš´éœ²ç»™æŒ‰é’®çš„å‡½æ•°
    window.setShape = function(type, btn) {
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        generateShape(type);
    }
    
    // çª—å£è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>