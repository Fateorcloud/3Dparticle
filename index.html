<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hand Magic</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: none; }
        #input_video { position: absolute; top: -9999px; left: -9999px; transform: scaleX(-1); }
        
        /* åŠ è½½æç¤º */
        #loading {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: #00d2ff; font-size: 18px; text-align: center; width: 100%;
            text-shadow: 0 0 10px rgba(0,210,255,0.5); pointer-events: none;
            transition: opacity 0.5s; z-index: 999;
        }
        
        /* åº•éƒ¨æŒ‰é’®æ  */
        #ui-bar {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 15px; z-index: 100;
        }
        .btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 16px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .btn.active { background: #00d2ff; color: #000; font-weight: bold; border-color: #00d2ff; }
    </style>

    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://unpkg.zhimg.com/@mediapipe/camera_utils@0.3.1632432234/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.zhimg.com/@mediapipe/control_utils@0.6.1629159505/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.zhimg.com/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.zhimg.com/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loading">
        âš¡ æ­£åœ¨ä»çŸ¥ä¹èŠ‚ç‚¹åŠ è½½æ¨¡å‹...<br>
        <span style="font-size:12px;color:#aaa;margin-top:5px;display:block">é¦–æ¬¡åŠ è½½çº¦éœ€ 5 ç§’ï¼Œè¯·å…è®¸æ‘„åƒå¤´æƒé™</span>
    </div>
    
    <video id="input_video" playsinline webkit-playsinline></video>

    <div id="ui-bar">
        <button class="btn active" onclick="setShape('heart', this)">â¤ çˆ±å¿ƒ</button>
        <button class="btn" onclick="setShape('saturn', this)">ğŸª åœŸæ˜Ÿ</button>
    </div>

<script>
    // === æ€§èƒ½é…ç½® ===
    const PARTICLE_COUNT = 12000; // é™ä½ç²’å­æ•°ï¼Œä¿è¯æ‰‹æœºä¸å‘çƒ«
    
    let scene, camera, renderer, particles, material;
    let basePositions = new Float32Array(PARTICLE_COUNT * 3);
    let handScale = 1.0, targetScale = 1.0;

    // === 1. åˆå§‹åŒ– 3D ===
    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 25;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(PARTICLE_COUNT * 3);
        for(let i=0; i<PARTICLE_COUNT*3; i++) pos[i] = (Math.random()-0.5)*60;
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));

        material = new THREE.PointsMaterial({
            color: 0x00d2ff, size: 0.2, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending
        });

        particles = new THREE.Points(geo, material);
        scene.add(particles);
        generateShape('heart');
        animate();
    }

    // === 2. å½¢çŠ¶ç®—æ³• ===
    function generateShape(type) {
        for(let i=0; i<PARTICLE_COUNT; i++) {
            const t = Math.random()*Math.PI*2, p = Math.acos(2*Math.random()-1);
            let x=0,y=0,z=0;
            if(type==='heart') {
                x=16*Math.pow(Math.sin(t),3); y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); z=(Math.random()-0.5)*4;
                let s=Math.cbrt(Math.random())*0.6; x*=s;y*=s;z*=s;
            } else { // saturn
                 if(Math.random()>0.5) { let r=7*Math.cbrt(Math.random()); x=r*Math.sin(p)*Math.cos(t); y=r*Math.sin(p)*Math.sin(t); z=r*Math.cos(p); }
                 else { let r=Math.sqrt(Math.random()*150+50); x=r*Math.cos(t); y=r*Math.sin(t)*0.4; z=r*Math.sin(t)*0.5; y+=x*0.2; }
            }
            basePositions[i*3]=x; basePositions[i*3+1]=y; basePositions[i*3+2]=z;
        }
    }

    // === 3. æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨çŸ¥ä¹æºåŠ è½½æ¨¡å‹æ–‡ä»¶ ===
    const hands = new Hands({
        locateFile: (file) => {
            // è¿™é‡Œå¼ºåˆ¶æŒ‡å‘çŸ¥ä¹çš„ CDN è·¯å¾„ï¼Œè§£å†³å¡é¡¿é—®é¢˜
            return `https://unpkg.zhimg.com/@mediapipe/hands@0.4.1646424915/${file}`;
        }
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0, // 0 = Lite (æé€Ÿæ¨¡å¼)ï¼Œé€‚åˆæ‰‹æœº
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(results => {
        document.getElementById('loading').style.display = 'none'; // éšè—åŠ è½½æç¤º
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const d = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
            targetScale = 0.2 + d * 5; 
            material.color.setHex(0x00ff88);
        } else {
            material.color.setHex(0x00d2ff);
        }
    });

    // === 4. æ‘„åƒå¤´é€»è¾‘ (å…¼å®¹ iOS/Android) ===
    const videoEl = document.getElementById('input_video');
    const cameraUtils = new Camera(videoEl, {
        onFrame: async () => { await hands.send({image: videoEl}); },
        width: 640, height: 480,
        facingMode: "user"
    });

    initThree();
    setTimeout(() => { cameraUtils.start(); }, 500);

    function animate() {
        requestAnimationFrame(animate);
        handScale += (targetScale - handScale) * 0.1;
        const pos = particles.geometry.attributes.position.array;
        for(let i=0; i<PARTICLE_COUNT*3; i++) {
            pos[i] += (basePositions[i]*handScale - pos[i])*0.1;
        }
        particles.geometry.attributes.position.needsUpdate = true;
        scene.rotation.y += 0.003;
        renderer.render(scene, camera);
    }
    
    window.setShape = function(type, btn) {
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        generateShape(type);
    }
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
